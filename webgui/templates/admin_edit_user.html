{% extends "base.html" %}
{% block title %}Edit User - {{ username }}{% endblock %}

{% block content %}
<div class="admin-edit-user">
    <div class="page-header">
        <a href="{{ url_for('admin_users') }}" class="back-link">‚Üê Back to Users</a>
        <h1>Edit User: {{ username }}</h1>
    </div>

    <div class="card">
        <form method="POST">
            <div class="form-group">
                <label>Username</label>
                <input type="text" value="{{ username }}" disabled>
            </div>

            <div class="form-group">
                <label>Name</label>
                <input type="text" value="{{ user.name }}" disabled>
            </div>

            <div class="form-group">
                <label>Email</label>
                <input type="email" value="{{ user.email }}" disabled>
            </div>

            <div class="form-group">
                <label for="role">Role</label>
                <select id="role" name="role">
                    <option value="user" {% if user.role == 'user' %}selected{% endif %}>User (can edit own houses)</option>
                    <option value="viewer" {% if user.role == 'viewer' %}selected{% endif %}>Viewer (read-only access)</option>
                    <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin (full access)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Houses</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="houses" value="*" {% if '*' in user.houses %}checked{% endif %}>
                        <span>All Houses (*)</span>
                    </label>
                    {% for house in all_houses %}
                    <label class="checkbox-label">
                        <input type="checkbox" name="houses" value="{{ house.id }}" {% if house.id in user.houses %}checked{% endif %}>
                        <span>{{ house.friendly_name }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <a href="{{ url_for('admin_users') }}" class="btn">Cancel</a>
            </div>
        </form>
    </div>

    <div class="card">
        <h2>User Info</h2>
        <dl class="info-list">
            <dt>Created</dt>
            <dd>{{ user.created_at[:16] if user.created_at else 'Unknown' }}</dd>

            {% if user.approved_by %}
            <dt>Approved By</dt>
            <dd>{{ user.approved_by }}</dd>

            <dt>Approved At</dt>
            <dd>{{ user.approved_at[:16] if user.approved_at else 'Unknown' }}</dd>
            {% endif %}

            {% if user.homeside_username %}
            <dt>HomeSide Username</dt>
            <dd>{{ user.homeside_username }}</dd>

            <dt>House Name</dt>
            <dd>{{ user.house_friendly_name or 'Not set' }}</dd>
            {% endif %}

            {% if user.role == 'deleted' %}
            <dt>Deleted At</dt>
            <dd>{{ user.deleted_at[:16] if user.deleted_at else 'Unknown' }}</dd>

            <dt>Scheduled Purge</dt>
            <dd>{{ user.scheduled_purge_at[:10] if user.scheduled_purge_at else 'Unknown' }}</dd>
            {% endif %}
        </dl>
    </div>

    <div class="card danger-zone">
        <h2>Danger Zone</h2>

        {% if user.role != 'deleted' %}
        <div class="danger-action">
            <div class="danger-info">
                <h3>Disable Account</h3>
                <p>Stop data collection. User cannot login. Account and data will be permanently deleted in 30 days. Can be restored before then.</p>
            </div>
            <form method="POST" action="{{ url_for('admin_soft_delete_user', username=username) }}"
                  onsubmit="return confirm('Disable this account? Data collection will stop and account will be scheduled for deletion in 30 days.');">
                <button type="submit" class="btn btn-warning">Disable Account</button>
            </form>
        </div>
        {% else %}
        <div class="danger-action restore-action">
            <div class="danger-info">
                <h3>Restore Account</h3>
                <p>Re-enable this account and restart data collection. Scheduled purge: <strong>{{ user.scheduled_purge_at[:10] if user.scheduled_purge_at else 'Unknown' }}</strong></p>
            </div>
            <form method="POST" action="{{ url_for('admin_restore_user', username=username) }}">
                <button type="submit" class="btn btn-success">Restore Account</button>
            </form>
        </div>
        {% endif %}

        <div class="danger-action">
            <div class="danger-info">
                <h3>Permanent Deletion</h3>
                <p>Immediately and permanently delete user account and ALL associated data including:
                    profile, environment file, Docker container, and InfluxDB time-series data.
                    <strong>This cannot be undone.</strong></p>
            </div>
            <form method="POST" action="{{ url_for('admin_hard_delete_user', username=username) }}"
                  class="hard-delete-form"
                  onsubmit="return confirm('PERMANENT DELETION: This will delete the user and ALL their data forever. This cannot be undone!');">
                <div class="form-group confirm-group">
                    <label>Type <strong>{{ username }}</strong> to confirm:</label>
                    <input type="text" name="confirm_delete" placeholder="{{ username }}" required
                           pattern="{{ username }}" title="Please type the username exactly">
                </div>
                <button type="submit" class="btn btn-danger">Delete Forever</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
