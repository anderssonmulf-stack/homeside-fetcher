{% extends "base.html" %}
{% block title %}{{ profile.friendly_name or house_id }}{% endblock %}

{% block content %}
<div class="house-detail">
    <div class="page-header">
        <a href="{{ url_for('dashboard') }}" class="back-link">‚Üê Back to Dashboard</a>
        <h1 class="friendly-name">{{ profile.friendly_name or house_id }}</h1>
        <p class="subtitle">{{ profile.customer_id }}</p>
    </div>

    {% if thermal_test.status == 'approved' %}
    <div class="alert alert-info">
        <span>Thermal calibration test approved for tonight. Heating starts at 19:00, cooldown measurement 23:00-07:00.</span>
    </div>
    {% elif thermal_test.status == 'in_progress' %}
    <div class="alert alert-warning">
        <span>Thermal calibration test in progress. The heating curve is under test control ‚Äî normal adjustments are paused.</span>
    </div>
    {% elif thermal_test.status == 'pending_approval' %}
    <div class="alert alert-info">
        <span>Thermal calibration test requested ‚Äî check your email to approve or decline.</span>
    </div>
    {% endif %}

    <!-- Current Status Card -->
    <div class="status-card">
        <h2>Current Status</h2>
        {% if realtime %}
        <div class="status-grid">
            <div class="status-item">
                <span class="status-label">Room Temperature</span>
                <span class="status-value large">{{ "%.1f"|format(realtime.room_temperature) }}¬∞C</span>
            </div>
            <div class="status-item">
                <span class="status-label">Target (HomeSide)</span>
                <span class="status-value">{{ "%.1f"|format(realtime.target_temp_setpoint) if realtime.target_temp_setpoint else 'N/A' }}¬∞C</span>
            </div>
            <div class="status-item">
                <span class="status-label">Outdoor</span>
                <span class="status-value">{{ "%.1f"|format(realtime.outdoor_temperature) }}¬∞C</span>
            </div>
            <div class="status-item">
                <span class="status-label">Supply</span>
                <span class="status-value">{{ "%.1f"|format(realtime.supply_temp) if realtime.supply_temp else 'N/A' }}¬∞C</span>
            </div>
            <div class="status-item">
                <span class="status-label">Return</span>
                <span class="status-value">{{ "%.1f"|format(realtime.return_temp) if realtime.return_temp else 'N/A' }}¬∞C</span>
            </div>
            <div class="status-item">
                <span class="status-label">Hot Water</span>
                <span class="status-value">{{ "%.1f"|format(realtime.hot_water_temp) if realtime.hot_water_temp else 'N/A' }}¬∞C</span>
            </div>
            <div class="status-item">
                <span class="status-label">Pressure</span>
                <span class="status-value">{{ "%.2f"|format(realtime.system_pressure) if realtime.system_pressure else 'N/A' }} bar</span>
            </div>
            <div class="status-item">
                <span class="status-label">Away Mode</span>
                <span class="status-value {{ 'active' if realtime.away_mode else '' }}">{{ 'ON' if realtime.away_mode else 'OFF' }}</span>
            </div>
        </div>
        <p class="update-time {% if realtime.age_minutes and realtime.age_minutes <= 16 %}fresh{% else %}stale{% endif %}">
            Last updated: {{ realtime.timestamp_friendly }}
            {% if realtime.age_minutes %}({{ realtime.age_minutes|int }} min ago){% endif %}
        </p>
        {% else %}
        <p class="muted">No real-time data available. The heating system may be offline.</p>
        {% endif %}
    </div>

    {% if forecast %}
    <!-- Forecast Card -->
    <div class="card">
        <h2>Weather Forecast</h2>
        <div class="forecast-summary">
            <div class="forecast-item">
                <span class="label">Trend</span>
                <span class="value trend-{{ forecast.trend|lower if forecast.trend else 'unknown' }}">
                    {{ forecast.trend or 'Unknown' }}
                    {% if forecast.temp_change %}
                    ({{ "%.1f"|format(forecast.temp_change) }}¬∞C)
                    {% endif %}
                </span>
            </div>
            <div class="forecast-item">
                <span class="label">Expected Range</span>
                <span class="value">
                    {{ "%.1f"|format(forecast.min_temp) if forecast.min_temp else '?' }}¬∞C
                    to
                    {{ "%.1f"|format(forecast.max_temp) if forecast.max_temp else '?' }}¬∞C
                </span>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="detail-grid">
        {% if is_own_house %}
        {% if thermal_test.status in ['approved', 'in_progress', 'pending_approval'] %}
        <div class="alert alert-{% if thermal_test.status == 'in_progress' %}warning{% else %}info{% endif %}" style="grid-column: 1 / -1;">
            {% if thermal_test.status == 'approved' %}
            <span>Thermal calibration scheduled for tonight (19:00-07:00). Settings changes will take effect after the test.</span>
            {% elif thermal_test.status == 'in_progress' %}
            <span>Thermal calibration in progress. Settings changes will take effect after the test completes.</span>
            {% elif thermal_test.status == 'pending_approval' %}
            <span>Thermal calibration requested ‚Äî check your email to approve.</span>
            {% endif %}
        </div>
        {% endif %}
        <!-- Comfort Settings Card (only shown for own house) -->
        <div class="card">
            <h2>Comfort Settings</h2>
            <p class="card-description">These settings control the heating optimization algorithm.</p>

            <form method="POST" action="{{ url_for('update_house_settings', house_id=house_id) }}">
                <div class="form-group">
                    <label for="target_indoor_temp">Target Indoor Temperature (¬∞C)</label>
                    <input type="number" id="target_indoor_temp" name="target_indoor_temp"
                           value="{{ profile.comfort.target_indoor_temp }}"
                           step="0.5" min="15" max="28"
                           {% if not can_edit %}disabled{% endif %}>
                    {% if realtime and realtime.target_temp_setpoint %}
                    <small class="help-text">
                        HomeSide setpoint: {{ "%.1f"|format(realtime.target_temp_setpoint) }}¬∞C
                        {% if realtime.target_temp_setpoint != profile.comfort.target_indoor_temp %}
                        <span style="color: #e67e22;">&mdash; differs from optimization target</span>
                        {% endif %}
                    </small>
                    {% else %}
                    <small class="help-text">The temperature the system aims to maintain.</small>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="acceptable_deviation">
                        Acceptable Deviation: <strong><span id="deviation-display">{{ profile.comfort.acceptable_deviation }}</span>¬∞C</strong>
                    </label>
                    <input type="range" id="acceptable_deviation" name="acceptable_deviation"
                           value="{{ profile.comfort.acceptable_deviation }}"
                           step="0.1" min="0.3" max="1.0"
                           style="width: 100%;"
                           {% if not can_edit %}disabled{% endif %}
                           oninput="updateDeviationDisplay(this.value)">
                    <div style="display: flex; justify-content: space-between; font-size: 0.75em; color: #888; margin-top: 2px;">
                        <span>0.3¬∞C (tight)</span>
                        <span>1.0¬∞C (relaxed)</span>
                    </div>
                    <small class="help-text" id="deviation-help">
                        The system keeps indoor temperature within &plusmn;{{ profile.comfort.acceptable_deviation }}¬∞C of target.
                        Full comfort range: {{ "%.1f"|format(profile.comfort.target_indoor_temp - profile.comfort.acceptable_deviation) }}&ndash;{{ "%.1f"|format(profile.comfort.target_indoor_temp + profile.comfort.acceptable_deviation) }}¬∞C.
                    </small>
                </div>

                {% if can_edit %}
                <button type="submit" class="btn btn-primary">Save Changes</button>
                {% endif %}
            </form>
        </div>

        <script>
        function updateDeviationDisplay(val) {
            document.getElementById('deviation-display').textContent = parseFloat(val).toFixed(1);
            var target = parseFloat(document.getElementById('target_indoor_temp').value) || 22.0;
            var dev = parseFloat(val);
            var lo = (target - dev).toFixed(1);
            var hi = (target + dev).toFixed(1);
            document.getElementById('deviation-help').innerHTML =
                'The system keeps indoor temperature within &plusmn;' + dev.toFixed(1) + '¬∞C of target. ' +
                'Full comfort range: ' + lo + '&ndash;' + hi + '¬∞C.';
        }
        </script>

        {% if can_edit %}
        <!-- Curve Control Mode Card (admin only) -->
        <div class="card">
            <h2>Curve Control Mode</h2>
            <p class="card-description">Controls how the heating curve is managed.</p>

            <form method="POST" action="{{ url_for('update_curve_control_mode', house_id=house_id) }}">
                <div class="mode-selector">
                    <label class="mode-option">
                        <input type="radio" name="curve_control_mode" value="intelligent"
                               {% if profile.heat_curve_control.curve_control_mode == 'intelligent' %}checked{% endif %}>
                        <span class="mode-label">
                            <strong>Intelligent</strong>
                            <small>ML weather-adjusted Yref</small>
                        </span>
                    </label>
                    <label class="mode-option">
                        <input type="radio" name="curve_control_mode" value="adaptive"
                               {% if profile.heat_curve_control.curve_control_mode == 'adaptive' %}checked{% endif %}>
                        <span class="mode-label">
                            <strong>Adaptive</strong>
                            <small>HomeSide built-in</small>
                        </span>
                    </label>
                    <label class="mode-option">
                        <input type="radio" name="curve_control_mode" value="manual"
                               {% if profile.heat_curve_control.curve_control_mode == 'manual' %}checked{% endif %}>
                        <span class="mode-label">
                            <strong>Manual</strong>
                            <small>Static curve</small>
                        </span>
                    </label>
                </div>

                {% if profile.heat_curve_control.in_control %}
                <div class="mode-status">
                    ML control active since {{ profile.heat_curve_control.entered_at[:16] if profile.heat_curve_control.entered_at else 'unknown' }}
                    {% if profile.heat_curve_control.ml_last_offset is not none %}
                    ‚Äî shift: {{ "%+.1f"|format(profile.heat_curve_control.ml_last_offset) }}¬∞C
                    {% endif %}
                </div>
                {% endif %}

                <button type="submit" class="btn btn-primary btn-small" style="margin-top: 12px;">Apply</button>
            </form>
        </div>
        {% endif %}

        <!-- Building Info Card (only shown for own house) -->
        <div class="card">
            <h2>Building Information</h2>

            <form method="POST" action="{{ url_for('update_house_settings', house_id=house_id) }}">
                <div class="form-group">
                    <label for="friendly_name">Friendly Name</label>
                    <input type="text" id="friendly_name" name="friendly_name"
                           value="{{ profile.friendly_name or '' }}"
                           placeholder="e.g., Daggis8"
                           {% if not can_edit %}disabled{% endif %}>
                    <small class="help-text">This name appears in dashboards and graphs.</small>
                </div>

                <div class="form-group">
                    <label for="building_description">Description</label>
                    <input type="text" id="building_description" name="building_description"
                           value="{{ profile.building.description or '' }}"
                           placeholder="e.g., Well-insulated 1990s villa"
                           {% if not can_edit %}disabled{% endif %}>
                </div>

                <div class="form-group">
                    <label for="distribution_type">Heat Distribution</label>
                    <select id="distribution_type" name="distribution_type" {% if not can_edit %}disabled{% endif %}>
                        <option value="floor" {% if profile.heating_system.distribution_type == 'floor' %}selected{% endif %}>Floor heating</option>
                        <option value="radiator" {% if profile.heating_system.distribution_type == 'radiator' %}selected{% endif %}>Radiators</option>
                        <option value="ventilation" {% if profile.heating_system.distribution_type == 'ventilation' %}selected{% endif %}>Ventilation (FTX)</option>
                        <option value="floor,radiator" {% if profile.heating_system.distribution_type == 'floor,radiator' %}selected{% endif %}>Floor + Radiators</option>
                    </select>
                    <small class="help-text">Affects thermal test calibration thresholds.</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="has_power_meter" value="true"
                               {% if profile.heating_system.has_power_meter %}checked{% endif %}
                               {% if not can_edit %}disabled{% endif %}>
                        Has primary power meter (dh_power)
                    </label>
                    <small class="help-text">If available, used for precise thermal test calibration.</small>
                </div>

                <div class="form-group">
                    <label for="meter_ids">Energy Meter IDs</label>
                    <input type="text" id="meter_ids" name="meter_ids"
                           value="{{ profile.meter_ids|join(', ') if profile.meter_ids else '' }}"
                           placeholder="e.g., 12345678, 87654321"
                           {% if not can_edit %}disabled{% endif %}>
                    <small class="help-text">District heating meter number(s), comma-separated. Required for automatic energy data import.</small>
                </div>

                {% if can_edit %}
                <button type="submit" class="btn btn-primary btn-small">Save Building Info</button>
                {% endif %}
            </form>

            <dl class="info-list" style="margin-top: 20px;">
                <dt>Customer ID</dt>
                <dd>{{ profile.customer_id }}</dd>

                <dt>Thermal Response</dt>
                <dd>
                    <span class="badge badge-{{ profile.building.thermal_response }}">
                        {{ profile.building.thermal_response|capitalize or 'Unknown' }}
                    </span>
                </dd>

                <dt>Max Supply Temperature</dt>
                <dd>{{ profile.heating_system.max_supply_temp }}¬∞C</dd>

                <dt>Response Time</dt>
                <dd>{{ profile.heating_system.response_time_minutes }} minutes</dd>
            </dl>
        </div>
        {% endif %}

        <!-- Learned Parameters Card -->
        <div class="card">
            <h2>Building Thermal Properties</h2>
            <p class="card-description">Automatically learned from how your building responds to outdoor conditions.</p>

            <dl class="info-list">
                {% if profile.learned.thermal_time_constant %}
                <dt>Thermal Inertia</dt>
                <dd>
                    <strong>{{ profile.learned.thermal_time_constant }} hours</strong>
                    <br>
                    <small style="color: #666;">
                        How quickly the building loses heat. Higher = better insulated/more thermal mass.
                        {% if profile.learned.thermal_time_constant_source %}
                        ({{ profile.learned.thermal_time_constant_source.replace('_', ' ') }})
                        {% endif %}
                    </small>
                </dd>
                {% endif %}

                {% if profile.energy_separation.heat_loss_k %}
                <dt>Heat Loss (k-value)</dt>
                <dd>
                    <strong>{{ "%.3f"|format(profile.energy_separation.heat_loss_k) }} kW/¬∞C</strong>
                    <br>
                    <small style="color: #666;">
                        Energy needed per degree temperature difference to outdoors.
                        At 0¬∞C outdoors: {{ "%.1f"|format(profile.energy_separation.heat_loss_k * profile.comfort.target_indoor_temp * 24) }} kWh/day.
                        At &minus;10¬∞C: {{ "%.0f"|format(profile.energy_separation.heat_loss_k * (profile.comfort.target_indoor_temp + 10) * 24) }} kWh/day.
                    </small>
                </dd>
                {% endif %}

                {% if profile.learned.thermal_time_constant and profile.energy_separation.heat_loss_k %}
                <dt>Cooling Examples</dt>
                <dd>
                    <small style="color: #666;">At 0¬∞C outdoors, with heating off:</small>
                    <table style="margin-top: 4px; font-size: 0.9em; border-collapse: collapse; width: 100%;">
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 3px 8px 3px 0;">Drop {{ profile.comfort.acceptable_deviation }}¬∞C</td>
                            <td style="padding: 3px 0;"><strong id="cool-time-dev"></strong></td>
                            <td style="padding: 3px 0 3px 8px; color: #888;">{{ "%.1f"|format(profile.comfort.target_indoor_temp) }} &rarr; {{ "%.1f"|format(profile.comfort.target_indoor_temp - profile.comfort.acceptable_deviation) }}¬∞C</td>
                        </tr>
                        <tr>
                            <td style="padding: 3px 8px 3px 0;">Drop {{ "%.1f"|format(profile.comfort.acceptable_deviation * 2) }}¬∞C</td>
                            <td style="padding: 3px 0;"><strong id="cool-time-swing"></strong></td>
                            <td style="padding: 3px 0 3px 8px; color: #888;">{{ "%.1f"|format(profile.comfort.target_indoor_temp) }} &rarr; {{ "%.1f"|format(profile.comfort.target_indoor_temp - profile.comfort.acceptable_deviation * 2) }}¬∞C</td>
                        </tr>
                    </table>
                    <script>
                    (function() {
                        var tau = {{ profile.learned.thermal_time_constant }};
                        var target = {{ profile.comfort.target_indoor_temp }};
                        var dev = {{ profile.comfort.acceptable_deviation }};
                        var outdoor = 0;
                        function coolingTime(drop) {
                            // Newton's cooling: t = -œÑ * ln((T_in - drop - T_out) / (T_in - T_out))
                            return -tau * Math.log((target - drop - outdoor) / (target - outdoor));
                        }
                        function formatTime(hours) {
                            var h = Math.floor(hours);
                            var m = Math.round((hours - h) * 60);
                            if (h > 0 && m > 0) return h + 'h ' + m + 'min';
                            if (h > 0) return h + 'h';
                            return m + 'min';
                        }
                        document.getElementById('cool-time-dev').textContent = formatTime(coolingTime(dev));
                        document.getElementById('cool-time-swing').textContent = formatTime(coolingTime(dev * 2));
                    })();
                    </script>
                </dd>
                {% endif %}

                <dt>Learning Status</dt>
                <dd>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: {{ (profile.learned.thermal_coefficient_confidence or 0) * 100 }}%"></div>
                    </div>
                    <span>
                        {% if profile.learned.thermal_coefficient_confidence %}
                        {{ "%.0f"|format(profile.learned.thermal_coefficient_confidence * 100) }}% confidence
                        {% else %}0% &mdash; collecting data
                        {% endif %}
                        ({{ profile.learned.total_samples }} samples)
                    </span>
                </dd>
            </dl>
        </div>

        <!-- Quick Links Card -->
        <div class="card">
            <h2>Quick Links</h2>
            <div class="quick-links-list">
                <a href="{{ url_for('house_graphs', house_id=house_id) }}" class="quick-link-item">
                    <span class="icon">üìà</span>
                    <span>Data Graphs</span>
                </a>
            </div>
        </div>

        {% if can_edit %}
        <!-- Energy Import Card -->
        <div class="card">
            <h2>Import Energy Data</h2>
            <p class="card-description">Import historical energy consumption from CSV file.</p>

            <form method="POST" action="{{ url_for('upload_energy_data', house_id=house_id) }}"
                  enctype="multipart/form-data">
                <div class="form-group">
                    <label for="energy_file">CSV File</label>
                    <input type="file" id="energy_file" name="energy_file"
                           accept=".csv" required class="file-input">
                    <small class="help-text">
                        Format: Semicolon-separated, Swedish decimal format (comma).
                    </small>
                </div>

                <div class="form-group">
                    <label for="energy_type">Energy Type</label>
                    <select id="energy_type" name="energy_type" class="role-select">
                        <option value="fjv_total">Fj√§rrv√§rme kWh (Total)</option>
                        <option value="fjv_heating">Fj√§rrv√§rme kWh (Heating)</option>
                        <option value="fjv_tapwater">Fj√§rrv√§rme kWh (Tap Water)</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">Preview Import</button>
            </form>
        </div>
        {% endif %}

        <!-- Change History Card -->
        <div class="card full-width">
            <h2>Change History</h2>

            {% if changes %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>User</th>
                        <th>Setting</th>
                        <th>Old Value</th>
                        <th>New Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for change in changes %}
                    <tr>
                        <td class="time">{{ change.timestamp }}</td>
                        <td>{{ change.user_id }}</td>
                        <td>{{ change.setting }}</td>
                        <td>{{ change.old_value }}</td>
                        <td>{{ change.new_value }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="muted">No changes recorded for this house.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
